#!/bin/bash
# =========================================================
# Single Binary Build Script for SSHX
# Author: Sumit
# =========================================================

set -euo pipefail
IFS=$'\n\t'

# ---------------- Config ----------------
SOURCE_FILE="main.go"
BINARY_NAME="sshx"
OUTPUT_DIR="./bin"

# Colors
GREEN="\e[32m"; BLUE="\e[34m"; RED="\e[31m"; NC="\e[0m"; BOLD="\e[1m"

ARCH=$(go env GOARCH)
echo -e "${BLUE}${BOLD}ğŸš€ Detecting Host Architecture: $ARCH${NC}"

# 1. Validation
if [ ! -f "$SOURCE_FILE" ]; then
    echo -e "${RED}âŒ Error: $SOURCE_FILE not found!${NC}"
    exit 1
fi

# 2. Create bin directory
mkdir -p "$OUTPUT_DIR"

# 3. Go Module Setup
if [ ! -f "go.mod" ]; then
    echo -e "${BLUE}âš™ï¸ Initializing Go module...${NC}"
    go mod init github.com/sumit/sshx &>/dev/null
    go mod tidy &>/dev/null
fi

# 4. Build process
echo -e "${BLUE}ğŸ”¨ Compiling $BINARY_NAME for $ARCH...${NC}"

# Static build
CGO_ENABLED=0 go build -ldflags="-s -w" -o "$OUTPUT_DIR/$BINARY_NAME" "$SOURCE_FILE"

# 5. Result check
if [ -f "$OUTPUT_DIR/$BINARY_NAME" ]; then
    BIN_SIZE=$(du -h "$OUTPUT_DIR/$BINARY_NAME" | cut -f1)
    echo -e "${GREEN}âœ… Build successful!${NC}"
    echo -e "ğŸ“Š Location: ${BOLD}$OUTPUT_DIR/$BINARY_NAME${NC}"
    echo -e "ğŸ“¦ Size: $BIN_SIZE"
else
    echo -e "${RED}âŒ Build failed!${NC}"
    exit 1
fi

echo -e "\nğŸ§ª Test: ./bin/$BINARY_NAME --version"
echo -e "ğŸ“¦ Install: sudo cp ./bin/$BINARY_NAME /usr/local/bin/"

echo -e "\n${GREEN}${BOLD}âš™ï¸ Main Binary Build Completed!${NC}"
