#!/usr/bin/env bash
# =========================================================
# esey-ssh-dev â€” Portable Arch Aware Clean Build Script
# Author: Sumit
# =========================================================

set -Eeuo pipefail

trap 'rc=$?; echo "âŒ Error on line $LINENO. Exit code: $rc"; exit $rc' ERR

IFS=$'\n\t'

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
GUI="$PROJECT_ROOT/gui"
LIB="$GUI/lib"
BIN="$PROJECT_ROOT/bin"

echo "ğŸ“ Project root: $PROJECT_ROOT"

echo "ğŸ” Detecting architecture..."
ARCH=$(uname -m)
echo "Architecture: $ARCH"

# ---------------- Dependency Check ----------------

need() {
  command -v "$1" >/dev/null 2>&1 || {
    echo "âŒ $1 not installed."
    exit 1
  }
}

echo "ğŸ“¦ Checking build dependencies..."

need go
need python3

# venv check
python3 -m venv --help >/dev/null 2>&1 || {
  echo "âŒ python3-venv not installed."
  exit 1
}

echo "âœ… All required dependencies found."

# ---------------- Clean Old Binaries ----------------

echo "ğŸ§¹ Removing old binaries..."

mkdir -p "$BIN"
rm -f "$BIN/sshx" \
      "$BIN/sshx-dev" \
      "$BIN/sshx-key" \
      "$GUI/sshx-gui" \
      "$LIB/git-auth" \
      "$LIB/sshx-cpy" \
      "$LIB/sshx-reset"
rm -rf "$GUI/_internal"

# ---------------- Build Go Binaries ----------------

echo "ğŸš€ Building Go binaries..."

cd "$PROJECT_ROOT"
./build-sshx
./build-init
./build-keyset

cd "$LIB"
./build-git-auth
./build-sshx-cpy
./build-reset

# ---------------- Python Build ----------------

echo "ğŸ Creating virtual environment..."

cd "$PROJECT_ROOT"
rm -rf .venv
python3 -m venv .venv

source .venv/bin/activate || {
  echo "âŒ Failed to activate venv"
  exit 1
}

pip install --upgrade pip
pip install --no-cache-dir pyinstaller

echo "ğŸ–¥ Building GUI..."

PYTHONNOUSERSITE=1 ./build-gui

echo "ğŸ“¦ Moving gui binaries..."

if [[ -d "$GUI/dist/sshx-gui" ]]; then
  mv -f "$GUI/dist/sshx-gui/sshx-gui" "$GUI/"
  mv -f "$GUI/dist/sshx-gui/_internal" "$GUI/"
else
  echo "âŒ GUI build failed â€” dist folder missing."
  exit 1
fi

rm -rf "$GUI/dist" "$GUI/build" "$GUI/sshx-gui.spec"

# ---------------- Cleanup ----------------

echo "ğŸ§¼ Cleaning virtual environment..."

deactivate 2>/dev/null || true
rm -rf "$PROJECT_ROOT/.venv"

chmod +x "$BIN/sshx" \
         "$BIN/sshx-dev" \
         "$BIN/sshx-key" \
         "$GUI/sshx-gui" \
         "$LIB/git-auth" \
         "$LIB/sshx-reset" \
         "$LIB/sshx-cpy"

if command -v tree >/dev/null 2>&1; then
  tree "$PROJECT_ROOT"
else
  echo "ğŸ“ Build complete."
fi

echo ""
echo "ğŸ” Verifying build artifacts..."

artifacts=(
  "$BIN/sshx"
  "$BIN/sshx-dev"
  "$BIN/sshx-key"
  "$GUI/sshx-gui"
  "$LIB/git-auth"
  "$LIB/sshx-reset"
  "$LIB/sshx-cpy"
)

for file in "${artifacts[@]}"; do
  if [[ ! -f "$file" ]]; then
    echo "âŒ Missing artifact: $file"
    exit 1
  fi

  if [[ ! -s "$file" ]]; then
    echo "âŒ Artifact exists but empty: $file"
    exit 1
  fi
done

echo ""
echo "âœ… All build artifacts verified."
echo ""
echo "âœ… Clean portable build successful!"
echo ""
