#!/usr/bin/env bash
# =========================================================
# esey-ssh-dev ‚Äî Portable Arch Aware Clean Build Script
# Author: Sumit
# =========================================================

set -Eeuo pipefail

trap 'rc=$?; echo "‚ùå Error on line $LINENO. Exit code: $rc"; exit $rc' ERR

IFS=$'\n\t'

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
GUI="$PROJECT_ROOT/gui"
LIB="$GUI/lib"
BIN="$PROJECT_ROOT/bin"

echo "üìÅ Project root: $PROJECT_ROOT"

# ---------------- Dependency Check ----------------

need() {
  command -v "$1" >/dev/null 2>&1 || {
    echo "‚ùå $1 not installed."
    exit 1
  }
}

echo "üì¶ Checking build dependencies..."

need go
need python3

# venv check
python3 -m venv --help >/dev/null 2>&1 || {
  echo "‚ùå python3-venv not installed."
  exit 1
}

echo "‚úÖ All required dependencies found."

# ---------------- Clean Old Binaries ----------------

echo "üßπ Removing old binaries..."

mkdir -p "$BIN"
rm -f "$BIN/sshx" \
      "$PROJECT_ROOT/sshx-dev" \
      "$BIN/sshx-key" \
      "$GUI/sshx-gui" \
      "$LIB/git-auth" \
      "$LIB/sshx-cpy" \
      "$LIB/sshx-reset"
rm -rf "$GUI/_internal"

# ---------------- Build Go Binaries ----------------

echo "üöÄ Building Go binaries..."

cd "$PROJECT_ROOT"
./build-sshx
./build-init
./build-keyset

cd "$LIB"
./build-git-auth
./build-sshx-cpy
./build-reset

# ---------------- Python Build ----------------

echo "üêç Creating virtual environment..."

cd "$PROJECT_ROOT"
rm -rf .venv
python3 -m venv --system-site-packages .venv

if [[ -f ".venv/bin/activate" ]]; then
  # shellcheck disable=SC1091
  source .venv/bin/activate
else
  echo "‚ùå venv activation script missing."
  exit 1
fi

pip install --upgrade pip setuptools wheel
pip install --no-cache-dir pyinstaller

echo "üñ• Building GUI..."

PYTHONNOUSERSITE=1 ./build-gui

echo "üì¶ Moving gui binaries..."

if [[ -f "$GUI/dist/sshx-gui/sshx-gui" ]]; then
  mv -f "$GUI/dist/sshx-gui/sshx-gui" "$GUI/"
  [[ -d "$GUI/dist/sshx-gui/_internal" ]] && \
      mv -f "$GUI/dist/sshx-gui/_internal" "$GUI/"
else
  echo "‚ùå GUI build failed ‚Äî binary missing."
  exit 1
fi

rm -rf "$GUI/dist" "$GUI/build" "$GUI/sshx-gui.spec"

# ---------------- Cleanup ----------------

echo "üßº Cleaning virtual environment..."

deactivate 2>/dev/null || true
rm -rf "$PROJECT_ROOT/.venv"

echo ""
echo "üîç Verifying build artifacts..."

artifacts=(
  "$BIN/sshx"
  "$BIN/sshx-key"
  "$GUI/sshx-gui"
  "$LIB/git-auth"
  "$LIB/sshx-reset"
  "$LIB/sshx-cpy"
  "$PROJECT_ROOT/sshx-dev"
)

for file in "${artifacts[@]}"; do
  if [[ ! -f "$file" ]]; then
    echo "‚ùå Missing artifact: $file"
    exit 1
  fi

  if [[ ! -s "$file" ]]; then
    echo "‚ùå Artifact exists but empty: $file"
    exit 1
  fi
done

echo ""
echo "‚úÖ All build artifacts verified."
echo ""
echo "üì¶ Build Summary:"
printf "  ‚úî %s\n" "${artifacts[@]}"
echo ""
for f in "${artifacts[@]}"; do
  chmod +x "$f"
done
echo ""
cd "$PROJECT_ROOT"

if [[ -x "$PROJECT_ROOT/sshx-dev" ]]; then
  "$PROJECT_ROOT/sshx-dev" install
else
  echo "‚ùå sshx-dev missing, cannot install."
  exit 1
fi

echo ""
echo "‚úÖ SSHX CLI + GUI installed successfully!"
echo ""
