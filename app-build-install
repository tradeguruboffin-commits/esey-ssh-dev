#!/usr/bin/env bash
# =========================================================
# easy-ssh-dev ‚Äî Portable Clean Build Script
# Author: Sumit
# =========================================================

set -Eeuo pipefail

trap 'rc=$?; echo "‚ùå Error on line $LINENO. Exit code: $rc"; exit $rc' ERR

IFS=$'\n\t'

# ---------------- Safe Argument Parser ----------------

DRY_RUN=false

parse_args() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --dry-run)
        DRY_RUN=true
        shift
        ;;
      --help|-h)
        echo "Usage: $0 [--dry-run]"
        exit 0
        ;;
      --*=*)
        echo "‚ùå Unknown option: ${1%%=*}"
        echo "Use --help to see available options."
        exit 1
        ;;
      --*)
        echo "‚ùå Unknown option: $1"
        echo "Use --help to see available options."
        exit 1
        ;;
      -*)
        echo "‚ùå Unknown option: $1"
        exit 1
        ;;
      *)
        echo "‚ùå Unexpected argument: $1"
        exit 1
        ;;
    esac
  done
}

parse_args "$@"

if [[ "$DRY_RUN" == true ]]; then
  echo "üß™ Running in DRY RUN mode ‚Äî no changes will be made."
fi

run() {
  echo "‚ûú $*"
  if [[ "$DRY_RUN" == false ]]; then
    command "$@"
  fi
}

# ---------------- Paths ----------------

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
GUI="$PROJECT_ROOT/gui"
LIB="$PROJECT_ROOT/lib"
BIN="$PROJECT_ROOT/bin"

echo "üìÅ Project root: $PROJECT_ROOT"

# ---------------- Dependency Check ----------------

need() {
  command -v "$1" >/dev/null 2>&1 || {
    echo "‚ùå $1 not installed."
    exit 1
  }
}

echo "üì¶ Checking build dependencies..."

need go
need python3

echo "üîé Detecting usable Python interpreter..."

PYTHON_BIN=""

if command -v python3 >/dev/null 2>&1; then
  if python3 -c 'import sys; exit(0 if sys.version_info >= (3,8) else 1)' 2>/dev/null; then
    if python3 -m venv --help >/dev/null 2>&1; then
      PYTHON_BIN="python3"
    fi
  fi
fi

if [[ -z "$PYTHON_BIN" ]] && command -v python >/dev/null 2>&1; then
  if python -c 'import sys; exit(0 if sys.version_info >= (3,8) else 1)' 2>/dev/null; then
    if python -m venv --help >/dev/null 2>&1; then
      PYTHON_BIN="python"
    fi
  fi
fi

if [[ -z "$PYTHON_BIN" ]]; then
  echo "‚ùå No usable Python 3.8+ with venv found."
  exit 1
fi

echo "‚úÖ Using $PYTHON_BIN ($( $PYTHON_BIN --version ))"

echo "‚úÖ All required dependencies found."

# ---------------- Clean Old Binaries ----------------

echo "üßπ Removing old binaries..."

run mkdir -p "$BIN"
run mkdir -p "$LIB"
run rm -f "$BIN/sshx" \
           "$PROJECT_ROOT/sshx-dev" \
           "$BIN/sshx-key" \
           "$GUI/sshx-gui" \
           "$LIB/git-auth" \
           "$LIB/sshx-cpy" \
           "$LIB/sshx-reset"
run rm -rf "$GUI/_internal"

# ---------------- Build Go Binaries ----------------

echo "üöÄ Building Go binaries..."

cd "$PROJECT_ROOT"
run ./build-bin
run ./build-lib
run ./build-init

# ---------------- Python Build ----------------

echo "üêç Entering virtual environment..."

cd "$PROJECT_ROOT"
run rm -rf .venv

run ./build-gui
cd "$PROJECT_ROOT"

echo "üì¶ Moving gui binaries..."

if [[ "$DRY_RUN" == false ]]; then
  if [[ -f "$GUI/dist/sshx-gui/sshx-gui" ]]; then
    run mv -f "$GUI/dist/sshx-gui/sshx-gui" "$GUI/"
    [[ -d "$GUI/dist/sshx-gui/_internal" ]] && \
      run mv -f "$GUI/dist/sshx-gui/_internal" "$GUI/"
  else
    echo "‚ùå GUI build failed ‚Äî binary missing."
    exit 1
  fi
else
  echo "‚ûú mv -f $GUI/dist/sshx-gui/sshx-gui $GUI/"
  echo "‚ûú mv -f $GUI/dist/sshx-gui/_internal $GUI/"
fi

run rm -rf "$GUI/dist" "$GUI/build" "$GUI/sshx-gui.spec"

# ---------------- Cleanup ----------------

echo "üßº Cleaning virtual environment..."

if [[ -n "${VIRTUAL_ENV:-}" ]]; then
    run deactivate || true
fi

if [[ "$DRY_RUN" == false ]]; then
  deactivate 2>/dev/null || true
fi

run rm -rf "$PROJECT_ROOT/.venv"

echo ""
echo "üîç Verifying build artifacts..."

artifacts=(
  "$BIN/sshx"
  "$BIN/sshx-key"
  "$GUI/sshx-gui"
  "$LIB/git-auth"
  "$LIB/sshx-reset"
  "$LIB/sshx-cpy"
  "$PROJECT_ROOT/sshx-dev"
)

if [[ "$DRY_RUN" == false ]]; then
  for file in "${artifacts[@]}"; do
    if [[ ! -f "$file" ]]; then
      echo "‚ùå Missing artifact: $file"
      exit 1
    fi

    if [[ ! -s "$file" ]]; then
      echo "‚ùå Artifact exists but empty: $file"
      exit 1
    fi
  done
  echo "‚úÖ All build artifacts verified."
else
  printf "‚ûú verify %s\n" "${artifacts[@]}"
fi

echo ""
echo "üì¶ Build Summary:"
printf "  ‚úî %s\n" "${artifacts[@]}"
echo ""

for f in "${artifacts[@]}"; do
  run chmod +x "$f"
done

cd "$PROJECT_ROOT"

if [[ "$DRY_RUN" == false ]]; then
  if [[ -x "$PROJECT_ROOT/sshx-dev" ]]; then
    run "$PROJECT_ROOT/sshx-dev" install
  else
    echo "‚ùå sshx-dev missing, cannot install."
    exit 1
  fi
else
  echo "‚ûú $PROJECT_ROOT/sshx-dev install"
fi

echo ""
echo "‚úÖ SSHX CLI + GUI installed successfully!"
echo ""
