#!/usr/bin/env bash
# =========================================================
# sshx v1.1 — Simple SSH Manager
# Author: Sumit
# =========================================================

set -Eeuo pipefail

VERSION="1.1"
CACHE="$HOME/.ssh/sshx.json"
KEY="$HOME/.ssh/id_ed25519"

GREEN="\e[32m"; RED="\e[31m"; YELLOW="\e[33m"; BLUE="\e[34m"; NC="\e[0m"

die() { echo -e "${RED}❌ $1${NC}"; exit 1; }
ok()  { echo -e "${GREEN}✅ $1${NC}"; }
warn(){ echo -e "${YELLOW}⚠️ $1${NC}"; }
info(){ echo -e "${BLUE}ℹ️ $1${NC}"; }

need() { command -v "$1" &>/dev/null || die "$1 not installed"; }

# ================= INIT =================
init() {
  mkdir -p ~/.ssh
  chmod 700 ~/.ssh

  need ssh
  need jq

  [ -f "$CACHE" ] || echo "{}" > "$CACHE"

  # Fix corrupted cache
  if ! jq empty "$CACHE" >/dev/null 2>&1; then
    warn "Cache corrupted — resetting"
    echo "{}" > "$CACHE"
  fi

  if [ ! -f "$KEY" ]; then
    info "Generating SSH key..."
    ssh-keygen -t ed25519 -f "$KEY" -N "" || die "Keygen failed"
  fi

  [ -f "$KEY.pub" ] || die "Public key missing"

  chmod 600 "$KEY" 2>/dev/null || true
  ok "Key permission fixed (600)"
}

# ================= PARSE =================
parse() {
  local input="$1"

  # IPv6 format: user@[2001:db8::1]:22
  if [[ "$input" =~ ^([^@]+)@\[(.+)\]:([0-9]+)$ ]]; then
    USER="${BASH_REMATCH[1]}"
    HOST="${BASH_REMATCH[2]}"
    PORT="${BASH_REMATCH[3]}"

  # IPv4 / hostname format: user@host:22
  elif [[ "$input" =~ ^([^@]+)@([^:]+):([0-9]+)$ ]]; then
    USER="${BASH_REMATCH[1]}"
    HOST="${BASH_REMATCH[2]}"
    PORT="${BASH_REMATCH[3]}"
  else
    die "Invalid format. Use: user@ip:port or user@[ipv6]:port"
  fi

  [[ "$PORT" =~ ^[0-9]+$ ]] || die "Invalid port"
}

# ================= CACHE =================
exists() {
  jq -e --arg key "$USER@$HOST:$PORT" 'has($key)' "$CACHE" >/dev/null 2>&1
}

add_cache() {
  jq --arg key "$USER@$HOST:$PORT" \
     --arg user "$USER" \
     --arg host "$HOST" \
     --argjson port "$PORT" \
     '. + {($key): {user:$user,host:$host,port:$port}}' \
     "$CACHE" > "$CACHE.tmp" && mv "$CACHE.tmp" "$CACHE"
}

remove_cache() {
  jq --arg key "$USER@$HOST:$PORT" \
     'del(.[$key])' \
     "$CACHE" > "$CACHE.tmp" && mv "$CACHE.tmp" "$CACHE"
}

# ================= CONNECT =================
connect() {

  local SSH_HOST="$HOST"
  [[ "$HOST" == *:* ]] && SSH_HOST="[$HOST]"  # IPv6 wrapper

  if ! exists; then
      info "First time connecting — testing connection and copying key if needed..."

      if command -v timeout >/dev/null; then
        timeout 5 ssh -o ConnectTimeout=5 -p "$PORT" "$USER@$SSH_HOST" exit 2>/dev/null \
          || warn "Password may be required"
      else
        ssh -o ConnectTimeout=5 -p "$PORT" "$USER@$SSH_HOST" exit 2>/dev/null \
          || warn "Password may be required"
      fi

      ssh-copy-id -i "$KEY.pub" -o StrictHostKeyChecking=no \
        -p "$PORT" "$USER@$SSH_HOST" \
        || warn "Key copy failed; enter password manually"

      add_cache
      ok "Host registered and key copied (if possible)"
  fi

  info "Connecting to $USER@$HOST:$PORT …"
  exec ssh -p "$PORT" "$USER@$SSH_HOST"
}

# ================= REMOVE =================
remove() {
  exists || die "Entry not found"

  # Safer known_hosts cleanup
  ssh-keygen -R "[$HOST]:$PORT" >/dev/null 2>&1 || true
  ok "Removed known_host entry"

  remove_cache
  ok "Removed entry from sshx cache"
}

# ================= LIST =================
list() {
  jq -r 'keys[]' "$CACHE" 2>/dev/null || echo "(empty)"
}

# ================= FZF =================
fzf_menu() {
  need fzf
  sel=$(list | fzf --prompt="SSH > ")
  [ -z "$sel" ] && exit 0
  sshx "$sel"
}

# ================= DOCTOR =================
doctor() {
  echo "sshx v$VERSION"
  need ssh
  need jq
  command -v fzf &>/dev/null && ok "fzf installed" || warn "fzf missing"
  [ -f "$KEY" ] && ok "SSH key exists" || warn "SSH key missing"
  stat -c "%a" "$KEY" 2>/dev/null | grep -q 600 && ok "Key permission OK" || warn "Fix key permission"
}

# ================= HELP =================
help() {
cat <<EOF
sshx v$VERSION — Simple SSH Manager

USAGE:
  sshx user@ip:port
  sshx user@[ipv6]:port
  sshx user@ip:port --remove

OTHER:
  sshx --list
  sshx --menu
  sshx --doctor
  sshx --version | -v
  sshx --help | -h
EOF
}

# ================= MAIN =================
init

[[ $# -eq 0 ]] && { help; exit 0; }

case "$1" in
  --help|-h|help) help ;;
  --version|-v|version) echo "sshx v$VERSION" ;;
  --list) list ;;
  --menu) fzf_menu ;;
  --doctor) doctor ;;
  *)
    parse "$1"
    case "${2:-}" in
      --remove) remove ;;
      ""|--) connect ;;
      *) help ;;
    esac
  ;;
esac
